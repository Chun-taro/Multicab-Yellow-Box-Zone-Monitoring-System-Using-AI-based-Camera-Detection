{% extends "layout.html" %}

{% block content %}
<div class="header">
    <h1 class="page-title">Live Monitoring</h1>
    <div class="status-badge status-live">
        <div class="status-dot"></div>
        <span>System Active</span>
    </div>
</div>

<div class="dashboard-grid">
    <!-- Video Feed Section -->
    <div class="card">
        <div class="card-header">
            <span><i class="fas fa-camera"></i> Camera Feed 01</span>
        </div>
        <div class="card-body" style="padding: 0; background: #000;">
            <div class="video-container">
                <img src="{{ url_for('dashboard.video_feed') }}" alt="Live Video Feed" class="video-feed">
            </div>
        </div>
    </div>

    <!-- Recent Violations Section -->
    <div class="card">
        <div class="card-header">
            <span><i class="fas fa-exclamation-triangle"></i> Recent Alerts</span>
        </div>
        <div class="card-body" id="recent-alerts-container">
            {% if violations %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Vehicle Type</th>
                            <th>Evidence</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for v in violations[:10] %}
                        <tr>
                            <td>{{ v.timestamp }}</td>
                            <td><span class="violation-tag">{{ v.label }}</span></td>
                            <td><button class="btn-view" onclick="openGlobalModal('{{ v.image_path }}')">View</button></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p style="color: var(--text-muted); text-align: center; margin-top: 2rem;">No recent violations detected.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function updateViolationList(data) {
        const container = document.getElementById('recent-alerts-container');
        if (data.length === 0) {
            container.innerHTML = '<p style="color: var(--text-muted); text-align: center; margin-top: 2rem;">No recent violations detected.</p>';
            return;
        }

        let html = `
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Vehicle Type</th>
                        <th>Evidence</th>
                    </tr>
                </thead>
                <tbody>`;
        
        data.forEach(v => {
            html += `
                <tr>
                    <td>${v.timestamp}</td>
                    <td><span class="violation-tag">${v.label}</span></td>
                    <td><button class="btn-view" onclick="openGlobalModal('${v.image_path}')">View</button></td>
                </tr>`;
        });

        html += `</tbody></table></div>`;
        container.innerHTML = html;
    }

    function pollForViolations() {
        // 1. Make a request to the long-polling endpoint and wait for the server to respond.
        fetch('/api/wait_for_violation')
            .then(response => response.json())
            .then(data => {
                // 2. If the server signals an update has occurred...
                if (data.update) {
                    console.log("New violation detected! Fetching updated list.");
                    // ...fetch the new list of recent violations.
                    fetch('/api/recent_violations')
                        .then(response => response.json())
                        .then(violations => updateViolationList(violations));
                }
                // 3. Whether there was an update or not, immediately poll again.
                pollForViolations();
            })
            .catch(error => {
                console.error('Long polling error:', error);
                setTimeout(pollForViolations, 5000); // Wait 5s on error before retrying
            });
    }

    // Start the long-polling process once the page is loaded.
    document.addEventListener('DOMContentLoaded', pollForViolations);
</script>
{% endblock %}